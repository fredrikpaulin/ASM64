# C64-Specific Features

ASM64 includes features specifically designed for Commodore 64 development.

## Memory Map

### Overview

| Address Range | Description |
|--------------|-------------|
| `$0000-$00FF` | Zero Page |
| `$0100-$01FF` | Stack |
| `$0200-$03FF` | System variables |
| `$0400-$07FF` | Default screen memory |
| `$0800-$9FFF` | BASIC program area / Free RAM |
| `$A000-$BFFF` | BASIC ROM / RAM |
| `$C000-$CFFF` | Free RAM |
| `$D000-$DFFF` | I/O / Character ROM / RAM |
| `$E000-$FFFF` | KERNAL ROM / RAM |

### Zero Page

Zero page addressing is faster and produces smaller code. ASM64 automatically uses zero-page addressing when operands are in the $00-$FF range.

**Best Practice:** Define zero-page variables before use:

```asm
; Zero page variables
zp_ptr      = $fb       ; 2 bytes
zp_temp     = $fd
zp_counter  = $fe

        lda (zp_ptr),y  ; Uses zero-page indirect
        inc zp_counter  ; Uses zero-page addressing
```

Common free zero-page locations: `$02-$7F` (when BASIC not needed), `$FB-$FE` (always free).

## BASIC Stub

Most C64 programs start with a BASIC line that calls the machine code.

### Automatic Generation

```asm
        *=$0801
        !basic              ; Generates: 10 SYS 2061

start:  sei                 ; Machine code starts here
        ...
```

### Custom Line Number

```asm
        *=$0801
        !basic 2025         ; Generates: 2025 SYS 2061
```

### Custom Address

```asm
        *=$0801
        !basic $0900        ; Generates: 10 SYS 2304

        *=$0900             ; Code at $0900
start:  ...
```

### Generated Bytes

The `!basic` directive generates:

```
$0801: 0B 08       ; Pointer to next BASIC line
$0803: 0A 00       ; Line number (10)
$0805: 9E          ; SYS token
$0806: 32 30 36 31 ; "2061" in PETSCII
$080A: 00          ; End of line
$080B: 00 00       ; End of BASIC program
```

## Character Encoding

### PETSCII

PETSCII is the C64's native character set. Key differences from ASCII:
- Uppercase and lowercase are swapped
- Special graphic characters
- Control codes differ

```asm
        !pet "HELLO"        ; Lowercase on screen (PETSCII uppercase)
        !pet "hello"        ; Uppercase on screen (PETSCII lowercase)
```

### Screen Codes

Screen codes map directly to screen memory. Different from PETSCII.

```asm
        !scr "HELLO"        ; Write directly to $0400
```

### Conversion Table (Partial)

| Character | ASCII | PETSCII | Screen Code |
|-----------|-------|---------|-------------|
| A-Z | $41-$5A | $C1-$DA | $01-$1A |
| a-z | $61-$7A | $41-$5A | $01-$1A |
| 0-9 | $30-$39 | $30-$39 | $30-$39 |
| @ | $40 | $40 | $00 |

## Hardware Registers

### VIC-II (Video)

| Address | Name | Description |
|---------|------|-------------|
| `$D000` | SP0X | Sprite 0 X position |
| `$D001` | SP0Y | Sprite 0 Y position |
| `$D010` | MSIGX | Sprite X MSB |
| `$D011` | SCROLY | Vertical scroll, screen height |
| `$D012` | RASTER | Current raster line |
| `$D015` | SPENA | Sprite enable |
| `$D016` | SCROLX | Horizontal scroll, screen width |
| `$D018` | VMCSB | Memory pointers |
| `$D019` | VICIRQ | Interrupt flags |
| `$D01A` | IRQMSK | Interrupt enable |
| `$D020` | EXTCOL | Border color |
| `$D021` | BGCOL0 | Background color 0 |
| `$D025` | SPMC0 | Sprite multicolor 0 |
| `$D026` | SPMC1 | Sprite multicolor 1 |
| `$D027-$D02E` | SP0COL-SP7COL | Sprite colors |

### SID (Sound)

| Address | Description |
|---------|-------------|
| `$D400-$D406` | Voice 1 |
| `$D407-$D40D` | Voice 2 |
| `$D40E-$D414` | Voice 3 |
| `$D415-$D417` | Filter |
| `$D418` | Volume and filter mode |
| `$D419-$D41C` | Paddle / oscillator readout |

### CIA 1 (Keyboard, Joystick)

| Address | Name | Description |
|---------|------|-------------|
| `$DC00` | CIAPRA | Port A (keyboard column) |
| `$DC01` | CIAPRB | Port B (keyboard row) |
| `$DC04-$DC05` | TIMALO/HI | Timer A |
| `$DC0D` | CIAICR | Interrupt control |
| `$DC0E` | CIACRA | Control register A |

### CIA 2 (Serial, VIC Bank)

| Address | Name | Description |
|---------|------|-------------|
| `$DD00` | CI2PRA | Port A (VIC bank, serial) |
| `$DD0D` | CI2ICR | Interrupt control |

## Bank Switching

The 6510 processor port at $0001 controls memory banking:

```asm
LORAM   = %00000001     ; BASIC ROM enable
HIRAM   = %00000010     ; KERNAL ROM enable
CHAREN  = %00000100     ; Character ROM enable

; Switch out BASIC ROM, keep KERNAL
        lda $01
        and #%11111110  ; Clear LORAM
        sta $01

; Switch to all RAM (for $D000-$DFFF)
        lda $01
        and #%11111000
        ora #%00000101  ; HIRAM + LORAM off, CHAREN on
        sta $01
```

### Common Configurations

| $01 Value | $A000-$BFFF | $D000-$DFFF | $E000-$FFFF |
|-----------|-------------|-------------|-------------|
| `$37` | BASIC ROM | I/O | KERNAL ROM |
| `$36` | RAM | I/O | KERNAL ROM |
| `$35` | RAM | I/O | RAM |
| `$34` | RAM | RAM | RAM |
| `$33` | RAM | Char ROM | RAM |

## Interrupts

### IRQ Setup

```asm
        sei                 ; Disable interrupts

        lda #<irq_handler
        sta $0314
        lda #>irq_handler
        sta $0315

        ; Or directly to hardware vector:
        lda #<irq_handler
        sta $fffe
        lda #>irq_handler
        sta $ffff

        cli                 ; Enable interrupts
```

### Raster IRQ

```asm
        sei

        lda #$7f
        sta $dc0d           ; Disable CIA IRQs
        sta $dd0d

        lda #$01
        sta $d01a           ; Enable raster IRQ

        lda #$80            ; Raster line
        sta $d012
        lda $d011
        and #$7f            ; Clear bit 8 of raster
        sta $d011

        lda #<raster_irq
        sta $fffe
        lda #>raster_irq
        sta $ffff

        lda $dc0d           ; Acknowledge CIA
        lda $dd0d
        asl $d019           ; Acknowledge VIC

        cli
        jmp *               ; Wait

raster_irq:
        ; Handle raster interrupt
        asl $d019           ; Acknowledge
        rti
```

## Cycle Counting

ASM64 provides cycle counts in listings for timing-critical code:

```
C000  78        2    SEI
C001  A9 00     2    LDA #$00
C003  8D 20 D0  4    STA $D020
C006  D0 F9     2+   BNE $C001    ; +1 if taken, +1 if page cross
```

### Cycle Notation

| Notation | Meaning |
|----------|---------|
| `2` | Always 2 cycles |
| `4+` | 4 cycles, +1 if page boundary crossed |
| `2++` | Branch: 2 not taken, 3 taken, 4 if page cross |

### Common Cycle Counts

| Instruction | Cycles | Notes |
|-------------|--------|-------|
| NOP | 2 | |
| LDA # | 2 | Immediate |
| LDA zp | 3 | Zero page |
| LDA abs | 4 | Absolute |
| LDA abs,X | 4+ | +1 page cross |
| STA zp | 3 | |
| STA abs | 4 | |
| JMP | 3 | |
| JSR | 6 | |
| RTS | 6 | |
| Branches | 2/3/4 | Not taken/taken/page cross |
